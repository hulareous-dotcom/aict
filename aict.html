<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, query, orderBy, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. H√ÄM G·ªåI NODE.JS SERVER (ƒê√É S·ª¨A) ---
        async function getGeminiResponse(userInput) {
            try {
                const response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userInput })
                });
                const data = await response.json();
                return data.reply; 
            } catch (error) {
                console.error("L·ªói:", error);
                return "Xin l·ªói, t√¥i ƒëang m·∫•t k·∫øt n·ªëi v·ªõi b·ªô n√£o server.";
            }
        }

        // --- 2. KH·ªûI T·∫†O CHAT ---
        window.initChatModule = async function() {
            if (window.chatInitialized) return;
            window.chatInitialized = true;

            const statusEl = document.getElementById('chat-status');
            const errorEl = document.getElementById('error-message');
            const inputEl = document.getElementById('chat-input');
            const btnEl = document.getElementById('chat-send-btn');
            const chatWindow = document.getElementById('chat-window');

            // C·∫§U H√åNH FIREBASE (Gi·ªØ nguy√™n c·ªßa b·∫°n)
            const firebaseConfig = {
                apiKey: "AIzaSyBMUvMykvoYX43Xl2LtZKKwN9IsBLN41Qs",
                authDomain: "aict-3d755.firebaseapp.com",
                projectId: "aict-3d755",
                storageBucket: "aict-3d755.firebasestorage.app",
                messagingSenderId: "30673828530",
                appId: "1:30673828530:web:7e4df9420ab25efcd167ab",
                measurementId: "G-3T9PB6P6SC"
            };

            // Initialize Firebase
            let db, auth;
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                statusEl.textContent = "ƒêang k·∫øt n·ªëi...";
            } catch (e) {
                console.error("Firebase error:", e);
                statusEl.textContent = "L·ªói C·∫•u h√¨nh";
                return;
            }

            // Authentication
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Auth error:", e);
            }

            // Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    statusEl.textContent = "ƒê√£ k·∫øt n·ªëi AI";
                    statusEl.className = "bg-green-100 text-xs text-center py-1 text-green-700 border-b border-green-200";
                    inputEl.disabled = false;
                    btnEl.disabled = false;
                    setupChatListeners(db, user.uid);
                } else {
                    statusEl.textContent = "M·∫•t k·∫øt n·ªëi";
                    inputEl.disabled = true;
                    btnEl.disabled = true;
                }
            });

            // Setup Chat Listeners
            function setupChatListeners(db, userId) {
                const messagesRef = collection(db, 'chats', 'global_room', 'messages');
                const q = query(messagesRef, orderBy('timestamp', 'asc'));

                // L·∫Øng nghe tin nh·∫Øn m·ªõi ƒë·ªÉ hi·ªÉn th·ªã
                onSnapshot(q, (snapshot) => {
                    chatWindow.innerHTML = `
                        <div class="chat-msg chat-msg-ai">
                            üëã Xin ch√†o! T√¥i l√† tr·ª£ l√Ω ·∫£o Gemini.<br>T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?
                        </div>
                    `;
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        renderMessage(data.text, data.sender, data.timestamp);
                    });
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                });

                // --- X·ª¨ L√ù KHI B·∫§M G·ª¨I (QUAN TR·ªåNG NH·∫§T) ---
                const form = document.getElementById('chat-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const text = inputEl.value.trim();
                    if (!text) return;

                    inputEl.value = ''; // X√≥a √¥ nh·∫≠p

                    // 1. G·ª≠i tin nh·∫Øn c·ªßa User l√™n Firebase (ƒë·ªÉ hi·ªÉn th·ªã)
                    await addDoc(messagesRef, {
                        text: text,
                        sender: 'user',
                        timestamp: serverTimestamp()
                    });

                    // 2. Hi·ªán hi·ªáu ·ª©ng ƒëang g√µ
                    const typingId = showTyping();

                    // 3. G·ªåI SERVER NODE.JS (GEMINI)
                    // Kh√¥ng d√πng setTimeout n·ªØa, g·ªçi th·∫≠t lu√¥n
                    const aiReply = await getGeminiResponse(text);

                    // 4. X√≥a hi·ªáu ·ª©ng g√µ & G·ª≠i c√¢u tr·∫£ l·ªùi c·ªßa AI l√™n Firebase
                    removeTyping(typingId);
                    
                    await addDoc(messagesRef, {
                        text: aiReply,
                        sender: 'ai',
                        timestamp: serverTimestamp()
                    });
                });
            }
        };

        // --- C√°c h√†m h·ªó tr·ª£ giao di·ªán ---
        function renderMessage(text, sender, timestamp) {
            const chatWindow = document.getElementById('chat-window');
            const div = document.createElement('div');
            const isUser = sender === 'user';
            div.className = `chat-msg ${isUser ? 'chat-msg-user' : 'chat-msg-ai'}`;
            
            // Chuy·ªÉn ƒë·ªïi Markdown c∆° b·∫£n sang HTML (xu·ªëng d√≤ng)
            const formattedText = text.replace(/\n/g, '<br>');

            div.innerHTML = `${formattedText}`;
            chatWindow.appendChild(div);
        }

        function showTyping() {
            const chatWindow = document.getElementById('chat-window');
            const div = document.createElement('div');
            const id = 'typing-' + Date.now();
            div.id = id;
            div.className = 'chat-msg chat-msg-ai';
            div.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return id;
        }

        function removeTyping(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
    </script>